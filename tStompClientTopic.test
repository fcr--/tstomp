# Stomp.test

package require tcltest

namespace import -force ::tcltest::*

# Software under test
package require tStomp


proc stompcallback {stompobject messageId destination timestamp expires priority messagebody} {
	puts "MessageID $messageId"
	puts "Destination $destination"
	puts "TimeStamp $timestamp"
	puts "Expires $expires"
	puts "Priority $priority"
	puts "Message $messagebody"
	set ::result $destination
 }
 

test Stomp_connectToServer {} -body {
	puts "Testing Stomp Connect"
	set ::result "NOT CONNECTED"
	Stomp ::s1 localhost 61613
	::s1 connect {set ::result CONNECTED}
	vwait ::result
	return $::result
} -result "CONNECTED"



test Stomp_sendToTopic {} -body {
	set ::result "NOT DONE"
	::s1 send /topic/topic1 "stompsimpleprotocol "
	::s1 subscribe /topic/topic1 {stompcallback $this $messageId $destination $timestamp $expires $priority $messagebody}	
	vwait ::result
	puts $::result
	return $::result
} -result "/topic/topic1"


test Stomp_SendUnicodeToSubscribedTopic {} -body {
	::s1 send /topic/topic1 Å�Å’s
} 


test Stomp_UnSubscribe {} -body {
	::s1  unsubscribe /topic/topic1 1 
}  

test Stomp_Disconnect {} -body {
	::s1  disconnect 
} 

catch {delete object ::s1}
cleanupTests
